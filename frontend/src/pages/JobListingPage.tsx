import { useEffect, useState } from "react";
import { useNavigate, useSearchParams } from "react-router-dom";
import Navbar from "../components/Navbar";
import Footer from "../components/Footer";
import ApplyJobModal from "../components/ApplyJobModal";
import "../styles/JobListingPage.css";

// TODO: Replace with actual files in Job List Page Images folder
import heroBg from "../images/Job List Page Images/hero-bg.svg";
import searchIcon from "../images/Job List Page Images/search.svg";
import locationIcon from "../images/Job List Page Images/location.svg";
import categoryIcon from "../images/Job List Page Images/category.svg";
import jobTypeIcon from "../images/Job List Page Images/job-type.svg";
import salaryIcon from "../images/Job List Page Images/salary.svg";
import levelIcon from "../images/Job List Page Images/level.svg";
import workModeIcon from "../images/Job List Page Images/work-mode.svg";
import educationIcon from "../images/Job List Page Images/education.svg";
import experienceIcon from "../images/Job List Page Images/experience.svg";
import skillIcon from "../images/Job List Page Images/skills.svg";
import promoIllustration from "../images/Job List Page Images/promo-illustration.svg";
import bookmarkIcon from "../images/Recruiter Job Post Page Images/bookmarkIcon.svg";
import savedBookmarkIcon from "../images/Recruiter Job Post Page Images/bookmarkFilled.svg";
import shareIcon from "../images/Recruiter Job Post Page Images/shareFg.svg";
import companyLogo from "../images/Recruiter Job Post Page Images/companyLogo.png";
import prevIcon from "../images/Employers Page Images/Prev Icon.svg";
import nextIcon from "../images/Employers Page Images/Next Icon.svg";
import minusIcon from "../images/Employers Page Images/minus.png";
import plusIcon from "../images/Employers Page Images/expand.png";
import brandSamsung from "../images/Job List Page Images/brand-samsung.svg";
import brandGoogle from "../images/Job List Page Images/brand-google.svg";
import brandFacebook from "../images/Job List Page Images/brand-facebook.svg";
import brandPinterest from "../images/Job List Page Images/brand-pinterest.svg";
import brandAvaya from "../images/Job List Page Images/brand-avaya.svg";
import brandAvis from "../images/Job List Page Images/brand-avis.svg";
import brandNielsen from "../images/Job List Page Images/brand-nielsen.svg";
import brandDoordash from "../images/Job List Page Images/brand-doordash.svg";

type JobCard = {
  id: string;
  companyName: string;
  jobTitle: string;
  workMode: string;
  location: string;
  jobType: string;
  companyLogo?: string;
  assessmentRequired?: boolean;
};

type ApplyModalJob = {
  jobTitle: string;
  companyName: string;
  education?: string;
  experience?: string;
};

type AppliedFilters = {
  search: string;
  location: string;
  department: string;
  workMode: string[];
  jobType: string[];
  jobLevel: string[];
  experience: string;
  education: string;
  skills: string;
  currency: string;
  salaryFrom: string;
  salaryTo: string;
};

const JobListingPage = () => {
  const navigate = useNavigate();
  const [searchParams] = useSearchParams();
  const [sortBy, setSortBy] = useState("newest");
  const [jobCards, setJobCards] = useState<JobCard[]>([]);
  const [totalJobs, setTotalJobs] = useState(0);
  const [page, setPage] = useState(1);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const limit = 20;
  const [searchTerm, setSearchTerm] = useState("");
  const [filterLocation, setFilterLocation] = useState("");
  const [filterDepartment, setFilterDepartment] = useState("");
  const [filterWorkMode, setFilterWorkMode] = useState({
    remote: false,
    "on-site": false,
    hybrid: false,
  });
  const [workModeCounts, setWorkModeCounts] = useState({
    remote: 0,
    "on-site": 0,
    hybrid: 0,
  });
  const [filterJobType, setFilterJobType] = useState({
    "Full Time": false,
    "Part Time": false,
    Contract: false,
    Internship: false,
  });
  const [jobTypeCounts, setJobTypeCounts] = useState({
    "Full Time": 0,
    "Part Time": 0,
    Contract: 0,
    Internship: 0,
  });
  const [filterJobLevel, setFilterJobLevel] = useState({
    Junior: false,
    Mid: false,
    Senior: false,
    Lead: false,
  });
  const [jobLevelCounts, setJobLevelCounts] = useState({
    Junior: 0,
    Mid: 0,
    Senior: 0,
    Lead: 0,
  });
  const [filterExperience, setFilterExperience] = useState("");
  const [filterEducation, setFilterEducation] = useState("");
  const [filterSkills, setFilterSkills] = useState("");
  const [filterCurrency, setFilterCurrency] = useState("");
  const [filterSalaryFrom, setFilterSalaryFrom] = useState("");
  const [filterSalaryTo, setFilterSalaryTo] = useState("");
  const [appliedFilters, setAppliedFilters] = useState<AppliedFilters>({
    search: "",
    location: "",
    department: "",
    workMode: [],
    jobType: [],
    jobLevel: [],
    experience: "",
    education: "",
    skills: "",
    currency: "",
    salaryFrom: "",
    salaryTo: "",
  });
  const [applyModalOpen, setApplyModalOpen] = useState(false);
  const [applyJobId, setApplyJobId] = useState<string | null>(null);
  const [applyJobDetails, setApplyJobDetails] = useState<ApplyModalJob | null>(
    null,
  );
  const [applyProfileResume, setApplyProfileResume] = useState<string>("");
  const [applyLoading, setApplyLoading] = useState(false);
  const [applyMessage, setApplyMessage] = useState("");
  const [applyError, setApplyError] = useState("");
  const [useCustomResume, setUseCustomResume] = useState(false);
  const [customResumeFile, setCustomResumeFile] = useState<File | null>(null);
  const [applyNote, setApplyNote] = useState("");
  const [appliedJobs, setAppliedJobs] = useState<Record<string, boolean>>({});
  const [savedJobs, setSavedJobs] = useState<Record<string, boolean>>({});
  const [confirmRequirements, setConfirmRequirements] = useState(false);
  const [confirmResume, setConfirmResume] = useState(false);

  const [expandedSections, setExpandedSections] = useState<
    Record<string, boolean>
  >({
    location: false,
    department: false,
    workMode: false,
    jobType: false,
    jobLevel: false,
    experience: false,
    education: false,
    skills: false,
    salaryRange: false,
  });

  const userDataStr = localStorage.getItem("userData");
  let userRole: string | null = null;
  if (userDataStr) {
    try {
      const parsed = JSON.parse(userDataStr);
      const isAdminEmail = parsed?.email === "hirelinknp@gmail.com";
      userRole = isAdminEmail ? "admin" : parsed?.role || null;
    } catch {
      userRole = null;
    }
  }

  const buildQueryParams = () => {
    const params = new URLSearchParams();
    params.set("sort", sortBy);
    params.set("page", String(page));
    params.set("limit", String(limit));

    const urlSearch = (searchParams.get("search") || "").trim();
    const urlLocation = (searchParams.get("location") || "").trim();
    const effectiveSearch = appliedFilters.search || urlSearch;
    const effectiveLocation = appliedFilters.location || urlLocation;

    if (effectiveSearch) params.set("search", effectiveSearch);
    if (effectiveLocation) params.set("location", effectiveLocation);
    if (appliedFilters.department)
      params.set("department", appliedFilters.department);
    if (appliedFilters.workMode.length > 0) {
      params.set("workMode", appliedFilters.workMode.join(","));
    }
    if (appliedFilters.jobType.length > 0) {
      params.set("jobType", appliedFilters.jobType.join(","));
    }
    if (appliedFilters.jobLevel.length > 0) {
      params.set("jobLevel", appliedFilters.jobLevel.join(","));
    }
    if (appliedFilters.experience)
      params.set("experience", appliedFilters.experience);
    if (appliedFilters.education)
      params.set("education", appliedFilters.education);
    if (appliedFilters.skills) params.set("skills", appliedFilters.skills);
    if (appliedFilters.currency)
      params.set("currency", appliedFilters.currency);
    const sanitizedSalaryFrom = appliedFilters.salaryFrom.replace(/,/g, "").trim();
    const sanitizedSalaryTo = appliedFilters.salaryTo.replace(/,/g, "").trim();
    if (sanitizedSalaryFrom) params.set("salaryFrom", sanitizedSalaryFrom);
    if (sanitizedSalaryTo) params.set("salaryTo", sanitizedSalaryTo);

    return params.toString();
  };

  const buildWorkModeCountQuery = () => {
    const params = new URLSearchParams();
    params.set("page", "1");
    params.set("limit", "2000");

    const urlSearch = (searchParams.get("search") || "").trim();
    const urlLocation = (searchParams.get("location") || "").trim();
    const effectiveSearch = appliedFilters.search || urlSearch;
    const effectiveLocation = appliedFilters.location || urlLocation;

    if (effectiveSearch) params.set("search", effectiveSearch);
    if (effectiveLocation) params.set("location", effectiveLocation);
    if (appliedFilters.department)
      params.set("department", appliedFilters.department);
    if (appliedFilters.jobType.length > 0) {
      params.set("jobType", appliedFilters.jobType.join(","));
    }
    if (appliedFilters.jobLevel.length > 0) {
      params.set("jobLevel", appliedFilters.jobLevel.join(","));
    }
    if (appliedFilters.experience)
      params.set("experience", appliedFilters.experience);
    if (appliedFilters.education)
      params.set("education", appliedFilters.education);
    if (appliedFilters.skills) params.set("skills", appliedFilters.skills);
    if (appliedFilters.currency)
      params.set("currency", appliedFilters.currency);
    const sanitizedSalaryFrom = appliedFilters.salaryFrom.replace(/,/g, "").trim();
    const sanitizedSalaryTo = appliedFilters.salaryTo.replace(/,/g, "").trim();
    if (sanitizedSalaryFrom) params.set("salaryFrom", sanitizedSalaryFrom);
    if (sanitizedSalaryTo) params.set("salaryTo", sanitizedSalaryTo);

    return params.toString();
  };

  const buildJobTypeCountQuery = () => {
    const params = new URLSearchParams();
    params.set("page", "1");
    params.set("limit", "2000");

    const urlSearch = (searchParams.get("search") || "").trim();
    const urlLocation = (searchParams.get("location") || "").trim();
    const effectiveSearch = appliedFilters.search || urlSearch;
    const effectiveLocation = appliedFilters.location || urlLocation;

    if (effectiveSearch) params.set("search", effectiveSearch);
    if (effectiveLocation) params.set("location", effectiveLocation);
    if (appliedFilters.department)
      params.set("department", appliedFilters.department);
    if (appliedFilters.workMode.length > 0) {
      params.set("workMode", appliedFilters.workMode.join(","));
    }
    if (appliedFilters.jobLevel.length > 0) {
      params.set("jobLevel", appliedFilters.jobLevel.join(","));
    }
    if (appliedFilters.experience)
      params.set("experience", appliedFilters.experience);
    if (appliedFilters.education)
      params.set("education", appliedFilters.education);
    if (appliedFilters.skills) params.set("skills", appliedFilters.skills);
    if (appliedFilters.currency)
      params.set("currency", appliedFilters.currency);
    const sanitizedSalaryFrom = appliedFilters.salaryFrom.replace(/,/g, "").trim();
    const sanitizedSalaryTo = appliedFilters.salaryTo.replace(/,/g, "").trim();
    if (sanitizedSalaryFrom) params.set("salaryFrom", sanitizedSalaryFrom);
    if (sanitizedSalaryTo) params.set("salaryTo", sanitizedSalaryTo);

    return params.toString();
  };

  const buildJobLevelCountQuery = () => {
    const params = new URLSearchParams();
    params.set("page", "1");
    params.set("limit", "2000");

    const urlSearch = (searchParams.get("search") || "").trim();
    const urlLocation = (searchParams.get("location") || "").trim();
    const effectiveSearch = appliedFilters.search || urlSearch;
    const effectiveLocation = appliedFilters.location || urlLocation;

    if (effectiveSearch) params.set("search", effectiveSearch);
    if (effectiveLocation) params.set("location", effectiveLocation);
    if (appliedFilters.department)
      params.set("department", appliedFilters.department);
    if (appliedFilters.workMode.length > 0) {
      params.set("workMode", appliedFilters.workMode.join(","));
    }
    if (appliedFilters.jobType.length > 0) {
      params.set("jobType", appliedFilters.jobType.join(","));
    }
    if (appliedFilters.experience)
      params.set("experience", appliedFilters.experience);
    if (appliedFilters.education)
      params.set("education", appliedFilters.education);
    if (appliedFilters.skills) params.set("skills", appliedFilters.skills);
    if (appliedFilters.currency)
      params.set("currency", appliedFilters.currency);
    const sanitizedSalaryFrom = appliedFilters.salaryFrom.replace(/,/g, "").trim();
    const sanitizedSalaryTo = appliedFilters.salaryTo.replace(/,/g, "").trim();
    if (sanitizedSalaryFrom) params.set("salaryFrom", sanitizedSalaryFrom);
    if (sanitizedSalaryTo) params.set("salaryTo", sanitizedSalaryTo);

    return params.toString();
  };

  const normalizeWorkModeKey = (
    mode?: string,
  ): "remote" | "on-site" | "hybrid" => {
    if (!mode) return "remote";
    const normalized = mode.toLowerCase().trim();
    if (normalized === "hybrid") return "hybrid";
    if (normalized === "on-site" || normalized === "onsite") return "on-site";
    return "remote";
  };

  const normalizeJobTypeKey = (
    jobType?: string,
  ): "Full Time" | "Part Time" | "Contract" | "Internship" => {
    const normalized = (jobType || "").toLowerCase().replace(/[-\s]/g, "");
    if (normalized.includes("parttime")) return "Part Time";
    if (normalized.includes("contract")) return "Contract";
    if (normalized.includes("intern")) return "Internship";
    return "Full Time";
  };

  const normalizeJobLevelKey = (
    jobLevel?: string,
  ): "Junior" | "Mid" | "Senior" | "Lead" => {
    const normalized = (jobLevel || "").toLowerCase();
    if (normalized.includes("lead")) return "Lead";
    if (normalized.includes("senior")) return "Senior";
    if (normalized.includes("mid")) return "Mid";
    return "Junior";
  };

  const applyFilters = (override?: Partial<AppliedFilters>) => {
    const workModeSelected = Object.entries(filterWorkMode)
      .filter(([, selected]) => selected)
      .map(([value]) => value);
    const jobTypeSelected = Object.entries(filterJobType)
      .filter(([, selected]) => selected)
      .map(([value]) => value);
    const jobLevelSelected = Object.entries(filterJobLevel)
      .filter(([, selected]) => selected)
      .map(([value]) => value);

    setAppliedFilters({
      search: searchTerm.trim(),
      location: filterLocation.trim(),
      department: filterDepartment.trim(),
      workMode: workModeSelected,
      jobType: jobTypeSelected,
      jobLevel: jobLevelSelected,
      experience: filterExperience.trim(),
      education: filterEducation.trim(),
      skills: filterSkills.trim(),
      currency: filterCurrency,
      salaryFrom: filterSalaryFrom.trim(),
      salaryTo: filterSalaryTo.trim(),
      ...override,
    });
    setPage(1);
  };

  const clearFilters = () => {
    setSearchTerm("");
    setFilterLocation("");
    setFilterDepartment("");
    setFilterWorkMode({
      remote: false,
      "on-site": false,
      hybrid: false,
    });
    setFilterJobType({
      "Full Time": false,
      "Part Time": false,
      Contract: false,
      Internship: false,
    });
    setFilterJobLevel({
      Junior: false,
      Mid: false,
      Senior: false,
      Lead: false,
    });
    setFilterExperience("");
    setFilterEducation("");
    setFilterSkills("");
    setFilterCurrency("");
    setFilterSalaryFrom("");
    setFilterSalaryTo("");
    setAppliedFilters({
      search: "",
      location: "",
      department: "",
      workMode: [],
      jobType: [],
      jobLevel: [],
      experience: "",
      education: "",
      skills: "",
      currency: "",
      salaryFrom: "",
      salaryTo: "",
    });
    setPage(1);
  };

  const fetchAppliedStatuses = async (jobIds: string[]) => {
    const token = localStorage.getItem("authToken");
    if (!token) return;
    try {
      const entries = await Promise.all(
        jobIds.map(async (jobId) => {
          const res = await fetch(
            `http://localhost:5000/api/applications/status/${jobId}`,
            { headers: { Authorization: `Bearer ${token}` } },
          );
          const data = await res.json();
          return [jobId, Boolean(data.applied)];
        }),
      );
      const map = Object.fromEntries(entries);
      setAppliedJobs(map);
    } catch {
      // ignore
    }
  };

  const fetchSavedStatuses = async (jobIds: string[]) => {
    const token = localStorage.getItem("authToken");
    if (!token) return;
    try {
      const entries = await Promise.all(
        jobIds.map(async (jobId) => {
          const res = await fetch(
            `http://localhost:5000/api/saved-jobs/status/${jobId}`,
            { headers: { Authorization: `Bearer ${token}` } },
          );
          const data = await res.json();
          return [jobId, Boolean(data.saved)];
        }),
      );
      const map = Object.fromEntries(entries);
      setSavedJobs(map);
    } catch {
      // ignore
    }
  };

  useEffect(() => {
    const initialSearch = (searchParams.get("search") || "").trim();
    const initialLocation = (searchParams.get("location") || "").trim();

    if (!initialSearch && !initialLocation) return;

    setSearchTerm(initialSearch);
    setFilterLocation(initialLocation);
    setAppliedFilters((prev) => ({
      ...prev,
      search: initialSearch,
      location: initialLocation,
    }));
    setPage(1);
  }, [searchParams]);

  useEffect(() => {
    const fetchJobs = async () => {
      try {
        setLoading(true);
        setError("");
        const response = await fetch(
          `http://localhost:5000/api/jobs?${buildQueryParams()}`,
        );
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data?.message || "Failed to load job posts");
        }

        const mappedJobs = (data.jobs || []).map((job: any) => ({
          id: job.id || job._id,
          companyName: job.companyName || job.department || "Company",
          jobTitle: job.jobTitle || "Untitled Role",
          workMode: job.workMode ? job.workMode.replace("-", " ") : "Remote",
          location: job.location || "Location",
          jobType: job.jobType || "Full-Time",
          companyLogo: job.companyLogo || "",
          assessmentRequired: Boolean(job.assessmentRequired),
        }));

        setJobCards(mappedJobs);
        setTotalJobs(data.total || 0);
        fetchAppliedStatuses(mappedJobs.map((j: JobCard) => j.id));
        fetchSavedStatuses(mappedJobs.map((j: JobCard) => j.id));

        // Work mode counts should reflect current filters except work mode itself.
        const countResponse = await fetch(
          `http://localhost:5000/api/jobs?${buildWorkModeCountQuery()}`,
        );
        const countData = await countResponse.json();
        if (countResponse.ok) {
          const counts = { remote: 0, "on-site": 0, hybrid: 0 };
          (countData.jobs || []).forEach((job: any) => {
            const key = normalizeWorkModeKey(job.workMode);
            counts[key] += 1;
          });
          setWorkModeCounts(counts);
        }

        // Job type counts should reflect current filters except job type itself.
        const jobTypeCountResponse = await fetch(
          `http://localhost:5000/api/jobs?${buildJobTypeCountQuery()}`,
        );
        const jobTypeCountData = await jobTypeCountResponse.json();
        if (jobTypeCountResponse.ok) {
          const counts = {
            "Full Time": 0,
            "Part Time": 0,
            Contract: 0,
            Internship: 0,
          };
          (jobTypeCountData.jobs || []).forEach((job: any) => {
            const key = normalizeJobTypeKey(job.jobType);
            counts[key] += 1;
          });
          setJobTypeCounts(counts);
        }

        // Job level counts should reflect current filters except job level itself.
        const jobLevelCountResponse = await fetch(
          `http://localhost:5000/api/jobs?${buildJobLevelCountQuery()}`,
        );
        const jobLevelCountData = await jobLevelCountResponse.json();
        if (jobLevelCountResponse.ok) {
          const counts = { Junior: 0, Mid: 0, Senior: 0, Lead: 0 };
          (jobLevelCountData.jobs || []).forEach((job: any) => {
            const key = normalizeJobLevelKey(job.jobLevel);
            counts[key] += 1;
          });
          setJobLevelCounts(counts);
        }
      } catch (err: any) {
        setError(err?.message || "Something went wrong");
      } finally {
        setLoading(false);
      }
    };

    fetchJobs();
  }, [sortBy, page, appliedFilters]);

  const startIndex = totalJobs > 0 ? (page - 1) * limit + 1 : 0;
  const endIndex = totalJobs > 0 ? (page - 1) * limit + jobCards.length : 0;
  const totalPages = Math.max(Math.ceil(totalJobs / limit), 1);
  const visiblePages = Array.from(
    { length: Math.min(totalPages, 7) },
    (_, index) => index + 1,
  );

  const resolveLogo = (logo?: string) => {
    if (!logo) return images.companyLogo;
    if (logo.startsWith("http")) return logo;
    return `http://localhost:5000${logo.startsWith("/") ? "" : "/"}${logo}`;
  };

  const formatWorkMode = (mode?: string) => {
    if (!mode) return "Remote";
    const normalized = mode.toLowerCase();
    if (normalized === "on-site" || normalized === "onsite") return "On-site";
    if (normalized === "hybrid") return "Hybrid";
    return "Remote";
  };

  const images = {
    heroBg,
    searchIcon,
    locationIcon,
    categoryIcon,
    jobTypeIcon,
    salaryIcon,
    levelIcon,
    workModeIcon,
    educationIcon,
    experienceIcon,
    skillIcon,
    promoIllustration,
    bookmarkIcon,
    savedBookmarkIcon,
    shareIcon,
    companyLogo,
    brandSamsung,
    brandGoogle,
    brandFacebook,
    brandPinterest,
    brandAvaya,
    brandAvis,
    brandNielsen,
    brandDoordash,
    prevIcon,
    nextIcon,
    minusIcon,
    plusIcon,
  };

  const toggleSection = (section: string) => {
    setExpandedSections((prev) => ({
      ...prev,
      [section]: !prev[section],
    }));
  };

  const openApplyModal = async (jobId: string) => {
    if (userRole !== "candidate") return;
    setApplyMessage("");
    setApplyError("");
    setApplyModalOpen(true);
    setApplyJobId(jobId);
    setApplyJobDetails(null);
    setUseCustomResume(false);
    setCustomResumeFile(null);
    setApplyNote("");
    setConfirmRequirements(false);
    setConfirmResume(false);

    const token = localStorage.getItem("authToken");
    if (!token) {
      setApplyError("Please log in to apply.");
      return;
    }
    try {
      setApplyLoading(true);
      const [jobRes, profileRes] = await Promise.all([
        fetch(`http://localhost:5000/api/jobs/${jobId}`),
        fetch("http://localhost:5000/api/profile/me", {
          headers: { Authorization: `Bearer ${token}` },
        }),
      ]);
      const jobData = await jobRes.json();
      const profileData = await profileRes.json();
      if (jobRes.ok) {
        setApplyJobDetails(jobData.job);
      }
      if (profileRes.ok) {
        setApplyProfileResume(profileData.user?.resume || "");
      }
    } catch (err: any) {
      setApplyError("Unable to load application details.");
    } finally {
      setApplyLoading(false);
    }
  };

  const closeApplyModal = () => {
    setApplyModalOpen(false);
  };

  const toggleSaveJob = async (jobId: string) => {
    const token = localStorage.getItem("authToken");
    if (!token) return;
    try {
      const res = await fetch("http://localhost:5000/api/saved-jobs/toggle", {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ jobId }),
      });
      const data = await res.json();
      if (res.ok) {
        setSavedJobs((prev) => ({ ...prev, [jobId]: Boolean(data.saved) }));
      }
    } catch {
      // ignore
    }
  };

  const handleConfirmApply = async () => {
    if (!confirmRequirements || !confirmResume) {
      setApplyError("Please confirm the requirements and resume review.");
      return;
    }
    if (!applyJobId) {
      setApplyError("Job ID missing.");
      return;
    }
    const token = localStorage.getItem("authToken");
    if (!token) {
      setApplyError("Please log in to apply.");
      return;
    }

    setApplyError("");
    try {
      setApplyLoading(true);
      const formData = new FormData();
      formData.append("jobId", applyJobId);
      formData.append("message", applyNote || "");
      if (useCustomResume && customResumeFile) {
        formData.append("resume", customResumeFile);
      } else if (applyProfileResume) {
        formData.append("resumeUrl", applyProfileResume);
      }

      const response = await fetch(
        "http://localhost:5000/api/applications/apply",
        {
          method: "POST",
          headers: { Authorization: `Bearer ${token}` },
          body: formData,
        },
      );
      const data = await response.json();
      if (!response.ok) {
        throw new Error(data?.message || "Failed to apply");
      }

      setApplyMessage("Application submitted. Recruiter will be notified.");
      setAppliedJobs((prev) => ({ ...prev, [applyJobId as string]: true }));
      setTimeout(() => {
        setApplyModalOpen(false);
      }, 1200);
    } catch (err: any) {
      setApplyError(err?.message || "Failed to apply");
    } finally {
      setApplyLoading(false);
    }
  };

  return (
    <div className="joblist-page">
      <Navbar />

      <section className="joblist-hero">
        <div className="joblist-hero-inner">
          <div className="joblist-hero-text">
            <h1>There Are {totalJobs.toLocaleString()} Jobs Here For you!</h1>
            <p>Discover your next career move, freelance gig, or internship</p>
          </div>
          <div className="joblist-breadcrumb">Home / Jobs Listing</div>
        </div>
        <div className="joblist-hero-search">
          <div className="joblist-search-pill">
            <div className="joblist-search-field">
              <img src={images.searchIcon} alt="Search" />
              <input
                type="text"
                placeholder="Search company or job title"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                onKeyDown={(e) => {
                  if (e.key === "Enter") {
                    applyFilters();
                  }
                }}
              />
            </div>
            <button
              className="joblist-search-btn"
              onClick={() => applyFilters()}
            >
              Search
            </button>
          </div>
        </div>
      </section>

      <section className="joblist-content">
        <div className="joblist-layout">
          <aside className="joblist-sidebar">
            <div className="joblist-card joblist-filter-group">
              <div className="joblist-filter-header">
                <span>Location</span>
                <button
                  className="joblist-toggle-icon"
                  onClick={() => toggleSection("location")}
                  aria-label={expandedSections.location ? "Collapse" : "Expand"}
                >
                  <img
                    src={
                      expandedSections.location
                        ? images.minusIcon
                        : images.plusIcon
                    }
                    alt={expandedSections.location ? "Collapse" : "Expand"}
                  />
                </button>
              </div>
              {expandedSections.location && (
                <div className="joblist-input-row">
                  <img src={images.locationIcon} alt="Location" />
                  <input
                    type="text"
                    placeholder="City or country"
                    value={filterLocation}
                    onChange={(e) => setFilterLocation(e.target.value)}
                  />
                </div>
              )}
            </div>

            <div className="joblist-divider"></div>

            <div className="joblist-card joblist-filter-group">
              <div className="joblist-filter-header">
                <span>Department</span>
                <button
                  className="joblist-toggle-icon"
                  onClick={() => toggleSection("department")}
                  aria-label={
                    expandedSections.department ? "Collapse" : "Expand"
                  }
                >
                  <img
                    src={
                      expandedSections.department
                        ? images.minusIcon
                        : images.plusIcon
                    }
                    alt={expandedSections.department ? "Collapse" : "Expand"}
                  />
                </button>
              </div>
              {expandedSections.department && (
                <div className="joblist-input-row">
                  <img src={images.categoryIcon} alt="Department" />
                  <input
                    type="text"
                    placeholder="Design, Product, Engineering"
                    value={filterDepartment}
                    onChange={(e) => setFilterDepartment(e.target.value)}
                  />
                </div>
              )}
            </div>

            <div className="joblist-divider"></div>

            <div className="joblist-card joblist-filter-group">
              <div className="joblist-filter-header">
                <span>Work Mode</span>
                <button
                  className="joblist-toggle-icon"
                  onClick={() => toggleSection("workMode")}
                  aria-label={expandedSections.workMode ? "Collapse" : "Expand"}
                >
                  <img
                    src={
                      expandedSections.workMode
                        ? images.minusIcon
                        : images.plusIcon
                    }
                    alt={expandedSections.workMode ? "Collapse" : "Expand"}
                  />
                </button>
              </div>
              {expandedSections.workMode && (
                <div className="joblist-checklist">
                  <label>
                    <input
                      type="checkbox"
                      checked={filterWorkMode.remote}
                      onChange={(e) =>
                        setFilterWorkMode((prev) => ({
                          ...prev,
                          remote: e.target.checked,
                        }))
                      }
                    />{" "}
                    Remote
                    <span className="joblist-count">{workModeCounts.remote}</span>
                  </label>
                  <label>
                    <input
                      type="checkbox"
                      checked={filterWorkMode["on-site"]}
                      onChange={(e) =>
                        setFilterWorkMode((prev) => ({
                          ...prev,
                          "on-site": e.target.checked,
                        }))
                      }
                    />{" "}
                    On-Site
                    <span className="joblist-count">{workModeCounts["on-site"]}</span>
                  </label>
                  <label>
                    <input
                      type="checkbox"
                      checked={filterWorkMode.hybrid}
                      onChange={(e) =>
                        setFilterWorkMode((prev) => ({
                          ...prev,
                          hybrid: e.target.checked,
                        }))
                      }
                    />{" "}
                    Hybrid
                    <span className="joblist-count">{workModeCounts.hybrid}</span>
                  </label>
                </div>
              )}
            </div>

            <div className="joblist-divider"></div>

            <div className="joblist-card joblist-filter-group">
              <div className="joblist-filter-header">
                <span>Job Type</span>
                <button
                  className="joblist-toggle-icon"
                  onClick={() => toggleSection("jobType")}
                  aria-label={expandedSections.jobType ? "Collapse" : "Expand"}
                >
                  <img
                    src={
                      expandedSections.jobType
                        ? images.minusIcon
                        : images.plusIcon
                    }
                    alt={expandedSections.jobType ? "Collapse" : "Expand"}
                  />
                </button>
              </div>
              {expandedSections.jobType && (
                <div className="joblist-checklist">
                  <label>
                    <input
                      type="checkbox"
                      checked={filterJobType["Full Time"]}
                      onChange={(e) =>
                        setFilterJobType((prev) => ({
                          ...prev,
                          "Full Time": e.target.checked,
                        }))
                      }
                    />{" "}
                    Full Time
                    <span className="joblist-count">{jobTypeCounts["Full Time"]}</span>
                  </label>
                  <label>
                    <input
                      type="checkbox"
                      checked={filterJobType["Part Time"]}
                      onChange={(e) =>
                        setFilterJobType((prev) => ({
                          ...prev,
                          "Part Time": e.target.checked,
                        }))
                      }
                    />{" "}
                    Part Time
                    <span className="joblist-count">{jobTypeCounts["Part Time"]}</span>
                  </label>
                  <label>
                    <input
                      type="checkbox"
                      checked={filterJobType.Contract}
                      onChange={(e) =>
                        setFilterJobType((prev) => ({
                          ...prev,
                          Contract: e.target.checked,
                        }))
                      }
                    />{" "}
                    Contract
                    <span className="joblist-count">{jobTypeCounts.Contract}</span>
                  </label>
                  <label>
                    <input
                      type="checkbox"
                      checked={filterJobType.Internship}
                      onChange={(e) =>
                        setFilterJobType((prev) => ({
                          ...prev,
                          Internship: e.target.checked,
                        }))
                      }
                    />{" "}
                    Internship
                    <span className="joblist-count">{jobTypeCounts.Internship}</span>
                  </label>
                </div>
              )}
            </div>

            <div className="joblist-divider"></div>

            <div className="joblist-card joblist-filter-group">
              <div className="joblist-filter-header">
                <span>Job Level</span>
                <button
                  className="joblist-toggle-icon"
                  onClick={() => toggleSection("jobLevel")}
                  aria-label={expandedSections.jobLevel ? "Collapse" : "Expand"}
                >
                  <img
                    src={
                      expandedSections.jobLevel
                        ? images.minusIcon
                        : images.plusIcon
                    }
                    alt={expandedSections.jobLevel ? "Collapse" : "Expand"}
                  />
                </button>
              </div>
              {expandedSections.jobLevel && (
                <div className="joblist-checklist">
                  <label>
                    <input
                      type="checkbox"
                      checked={filterJobLevel.Junior}
                      onChange={(e) =>
                        setFilterJobLevel((prev) => ({
                          ...prev,
                          Junior: e.target.checked,
                        }))
                      }
                    />{" "}
                    Junior
                    <span className="joblist-count">{jobLevelCounts.Junior}</span>
                  </label>
                  <label>
                    <input
                      type="checkbox"
                      checked={filterJobLevel.Mid}
                      onChange={(e) =>
                        setFilterJobLevel((prev) => ({
                          ...prev,
                          Mid: e.target.checked,
                        }))
                      }
                    />{" "}
                    Mid
                    <span className="joblist-count">{jobLevelCounts.Mid}</span>
                  </label>
                  <label>
                    <input
                      type="checkbox"
                      checked={filterJobLevel.Senior}
                      onChange={(e) =>
                        setFilterJobLevel((prev) => ({
                          ...prev,
                          Senior: e.target.checked,
                        }))
                      }
                    />{" "}
                    Senior
                    <span className="joblist-count">{jobLevelCounts.Senior}</span>
                  </label>
                  <label>
                    <input
                      type="checkbox"
                      checked={filterJobLevel.Lead}
                      onChange={(e) =>
                        setFilterJobLevel((prev) => ({
                          ...prev,
                          Lead: e.target.checked,
                        }))
                      }
                    />{" "}
                    Lead
                    <span className="joblist-count">{jobLevelCounts.Lead}</span>
                  </label>
                </div>
              )}
            </div>

            <div className="joblist-divider"></div>

            <div className="joblist-card joblist-filter-group">
              <div className="joblist-filter-header">
                <span>Experience</span>
                <button
                  className="joblist-toggle-icon"
                  onClick={() => toggleSection("experience")}
                  aria-label={
                    expandedSections.experience ? "Collapse" : "Expand"
                  }
                >
                  <img
                    src={
                      expandedSections.experience
                        ? images.minusIcon
                        : images.plusIcon
                    }
                    alt={expandedSections.experience ? "Collapse" : "Expand"}
                  />
                </button>
              </div>
              {expandedSections.experience && (
                <div className="joblist-input-row">
                  <img src={images.experienceIcon} alt="Experience" />
                  <input
                    type="text"
                    placeholder="E.g. 2+ years"
                    value={filterExperience}
                    onChange={(e) => setFilterExperience(e.target.value)}
                  />
                </div>
              )}
            </div>

            <div className="joblist-divider"></div>

            <div className="joblist-card joblist-filter-group">
              <div className="joblist-filter-header">
                <span>Education</span>
                <button
                  className="joblist-toggle-icon"
                  onClick={() => toggleSection("education")}
                  aria-label={
                    expandedSections.education ? "Collapse" : "Expand"
                  }
                >
                  <img
                    src={
                      expandedSections.education
                        ? images.minusIcon
                        : images.plusIcon
                    }
                    alt={expandedSections.education ? "Collapse" : "Expand"}
                  />
                </button>
              </div>
              {expandedSections.education && (
                <div className="joblist-input-row">
                  <img src={images.educationIcon} alt="Education" />
                  <input
                    type="text"
                    placeholder="Bachelor's Degree"
                    value={filterEducation}
                    onChange={(e) => setFilterEducation(e.target.value)}
                  />
                </div>
              )}
            </div>

            <div className="joblist-divider"></div>

            <div className="joblist-card joblist-filter-group">
              <div className="joblist-filter-header">
                <span>Required Skills</span>
                <button
                  className="joblist-toggle-icon"
                  onClick={() => toggleSection("skills")}
                  aria-label={expandedSections.skills ? "Collapse" : "Expand"}
                >
                  <img
                    src={
                      expandedSections.skills
                        ? images.minusIcon
                        : images.plusIcon
                    }
                    alt={expandedSections.skills ? "Collapse" : "Expand"}
                  />
                </button>
              </div>
              {expandedSections.skills && (
                <div className="joblist-input-row">
                  <img src={images.skillIcon} alt="Skills" />
                  <input
                    type="text"
                    placeholder="React, Figma, UX Research"
                    value={filterSkills}
                    onChange={(e) => setFilterSkills(e.target.value)}
                  />
                </div>
              )}
            </div>

            <div className="joblist-divider"></div>

            <div className="joblist-card joblist-filter-group">
              <div className="joblist-filter-header">
                <span>Salary Range</span>
                <button
                  className="joblist-toggle-icon"
                  onClick={() => toggleSection("salaryRange")}
                  aria-label={
                    expandedSections.salaryRange ? "Collapse" : "Expand"
                  }
                >
                  <img
                    src={
                      expandedSections.salaryRange
                        ? images.minusIcon
                        : images.plusIcon
                    }
                    alt={expandedSections.salaryRange ? "Collapse" : "Expand"}
                  />
                </button>
              </div>
              {expandedSections.salaryRange && (
                <div className="joblist-salary-range">
                  <div className="joblist-input-row">
                    <img src={images.salaryIcon} alt="Currency" />
                    <select
                      value={filterCurrency}
                      onChange={(e) => setFilterCurrency(e.target.value)}
                    >
                      <option value="" disabled>
                        Select currency
                      </option>
                      <option value="NPR">NPR (Rs.)</option>
                      <option value="INR">INR (₹)</option>
                      <option value="USD">USD ($)</option>
                      <option value="GBP">GBP (£)</option>
                    </select>
                  </div>
                  <div className="joblist-salary-inputs">
                    <input
                      type="text"
                      placeholder="From"
                      value={filterSalaryFrom}
                      onChange={(e) => setFilterSalaryFrom(e.target.value)}
                    />
                    <input
                      type="text"
                      placeholder="To"
                      value={filterSalaryTo}
                      onChange={(e) => setFilterSalaryTo(e.target.value)}
                    />
                  </div>
                </div>
              )}
            </div>

            <div className="joblist-filter-actions">
              <button
                className="joblist-apply-filter"
                onClick={() => applyFilters()}
              >
                Apply Filter
              </button>
              <button className="joblist-clear-filter" onClick={clearFilters}>
                Clear Filters
              </button>
            </div>

            <div className="joblist-card joblist-promo-card">
              <h4>Recruiting?</h4>
              <p>Advertise your jobs to millions of monthly users.</p>
              <button className="joblist-btn-outline">Post a Job</button>
              <img src={images.promoIllustration} alt="" />
            </div>
          </aside>

          <main className="joblist-main">
            <div className="joblist-main-header">
              <span>
                {loading
                  ? "Loading jobs..."
                  : `Showing ${startIndex}-${endIndex} of ${totalJobs} jobs`}
              </span>
              <div className="joblist-sort">
                <span>Sort by:</span>
                <select
                  className="joblist-sort-select"
                  value={sortBy}
                  onChange={(e) => {
                    setSortBy(e.target.value);
                    setPage(1);
                  }}
                >
                  <option value="newest">Newest Post</option>
                  <option value="oldest">Oldest Post</option>
                  <option value="salary">Salary</option>
                </select>
              </div>
            </div>

            {error && <div className="joblist-error">{error}</div>}
            {!error && !loading && jobCards.length === 0 && (
              <div className="joblist-empty">No jobs found.</div>
            )}
            <div className="joblist-grid">
              {jobCards.map((job) => (
                <article key={job.id} className="joblist-card-item">
                  <div className="joblist-card-top">
                    <img
                      src={resolveLogo(job.companyLogo)}
                      alt={job.companyName}
                      className="joblist-company-logo"
                    />
                    <div className="joblist-card-actions">
                      {userRole === "candidate" && (
                        <button
                          className="joblist-icon-btn"
                          onClick={() => toggleSaveJob(job.id)}
                        >
                        <img
                          src={
                            savedJobs[job.id]
                              ? images.savedBookmarkIcon
                              : images.bookmarkIcon
                          }
                          alt="Save"
                        />
                        </button>
                      )}
                      <button className="joblist-icon-btn">
                        <img src={images.shareIcon} alt="Share" />
                      </button>
                    </div>
                  </div>
                  <div className="joblist-card-company">{job.companyName}</div>
                  <div className="joblist-card-meta">
                    <img src={images.workModeIcon} alt="Work mode" />
                    {formatWorkMode(job.workMode)}
                  </div>
                  <h3 className="joblist-card-title">{job.jobTitle}</h3>
                  <div className="joblist-card-info">
                    <span>
                      <img src={images.locationIcon} alt="Location" />
                      {job.location}
                    </span>
                    <span>
                      <img src={images.jobTypeIcon} alt="Job type" />
                      {job.jobType}
                    </span>
                  </div>
                  <div className="joblist-card-buttons">
                    <button
                      className="joblist-btn-outline"
                      onClick={() => navigate(`/jobs/${job.id}`)}
                    >
                      View Details
                    </button>
                    {(userRole === "candidate" || !userRole) && (
                      <button
                        className={`joblist-btn-primary ${
                          userRole === "candidate" && appliedJobs[job.id]
                            ? "joblist-btn-applied"
                            : ""
                        }`}
                        onClick={() => {
                          if (!userRole) {
                            navigate("/login");
                            return;
                          }
                          if (
                            userRole === "candidate" &&
                            job.assessmentRequired &&
                            !appliedJobs[job.id]
                          ) {
                            navigate(`/jobs/${job.id}`);
                            return;
                          }
                          openApplyModal(job.id);
                        }}
                        disabled={userRole === "candidate" && appliedJobs[job.id]}
                      >
                        {userRole === "candidate" && appliedJobs[job.id]
                          ? "Applied"
                          : "Apply Now"}
                      </button>
                    )}
                  </div>
                </article>
              ))}
            </div>

            <div className="joblist-pagination">
              <div className="joblist-page-controls">
                <button
                  className="joblist-page-nav"
                  onClick={() => setPage((prev) => Math.max(prev - 1, 1))}
                  disabled={page === 1}
                >
                  <img src={images.prevIcon} alt="Previous" />
                </button>
                <div className="joblist-page-numbers">
                  {visiblePages.map((pageNumber) => (
                    <span
                      key={pageNumber}
                      className={`joblist-page-num ${
                        pageNumber === page ? "joblist-active" : ""
                      }`}
                      onClick={() => setPage(pageNumber)}
                      role="button"
                    >
                      {pageNumber}
                    </span>
                  ))}
                  {totalPages > 7 && (
                    <span className="joblist-page-num joblist-dots">...</span>
                  )}
                </div>
                <button
                  className="joblist-page-nav"
                  onClick={() =>
                    setPage((prev) => Math.min(prev + 1, totalPages))
                  }
                  disabled={page === totalPages}
                >
                  <img src={images.nextIcon} alt="Next" />
                </button>
              </div>
              <div className="joblist-page-info">
                Showing {startIndex} to {endIndex} of {totalJobs}
              </div>
            </div>
          </main>
        </div>
      </section>

      <ApplyJobModal
        isOpen={applyModalOpen}
        loading={applyLoading}
        job={applyJobDetails}
        profileResume={applyProfileResume}
        useCustomResume={useCustomResume}
        customResumeFile={customResumeFile}
        applyNote={applyNote}
        confirmRequirements={confirmRequirements}
        confirmResume={confirmResume}
        applyError={applyError}
        applyMessage={applyMessage}
        onClose={closeApplyModal}
        onConfirm={handleConfirmApply}
        onUseCustomResumeChange={setUseCustomResume}
        onCustomResumeChange={setCustomResumeFile}
        onApplyNoteChange={setApplyNote}
        onConfirmRequirementsChange={setConfirmRequirements}
        onConfirmResumeChange={setConfirmResume}
      />
      <section className="joblist-brands">
        <div className="joblist-brands-row">
          <img src={images.brandSamsung} alt="Samsung" />
          <img src={images.brandGoogle} alt="Google" />
          <img src={images.brandFacebook} alt="Facebook" />
          <img src={images.brandPinterest} alt="Pinterest" />
          <img src={images.brandAvaya} alt="Avaya" />
          <img src={images.brandAvis} alt="Avis" />
          <img src={images.brandNielsen} alt="Nielsen" />
          <img src={images.brandDoordash} alt="DoorDash" />
        </div>
      </section>

      <Footer />
    </div>
  );
};

export default JobListingPage;


